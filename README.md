# mw-api
MW api
Сервер для обработки запроса для представления статусов переданных в ЕГИСЗ документов

1. Скачать mw-api.zip
2. Распаковать
3. Перейти в каталог /mw-api
4. Установить зависимости: npm install
5. Установить Oracle Client, например Instant client 19.11 (скачивается с официального сайта,
   имя файла instantclient-basic-windows.x64-19.11.0.0.0dbru.zip). После распаковки содержимое
   архива копируется в каталог \node_modules\oracledb\build\Release\ проекта mw_api
7. В db.config.js изменить учетные данные для подключения к Oracle и MS SQL (Medwork)
8. Запустить сервер
   node app.js

Сервер работает на порту 5050.

Для получения данных нужно в PostMan или Insomnia послать GET-запрос по адресу
http://<your_IP>:5050/status/<номер_амбулаторной_карты>, например, http://10.2.56.4:5050/status/3455
Также можно отправить запрос и в браузере

Для получения документов для отдельных авторов за заданный интервал времени с определенными статусами
необходимо отправлять GET-запрос в формате JSON по адресу http://<your_IP>:5050/listdocs
Формат запроса:
{
        "beginInterval":"DD.MM.YYYY HH:MM:SS",
        "endInterval":"DD.MM.YYYY HH:MM:SS",
        "listStatus":[],
        "listDoctor":[]
 }
 Подробности см. в файле "Описание MW api.....docx"

Если документы найдены, возвратиться JSON со списком документов и их статусов
Если не найдены - вернется JSON-документ с ошибкой

Данный сервис может вызываться периодически с заданным интервалом или непосредственно при обращении из браузера.
db.config.js содержит 2 строки вида:
   const renewalInterval = 30000;   
   const docsTimeSlotInterval = 60; 
renewalInterval - интервал обновления статусов в Oracle  (таблица medbase.mw_docs_list) в миллисекундах. В поля STATUS_ID и STATUS_DATE для документа вносятся его последний статус и время изменения статуса из MedWork. При renewalInterval = 0 периодическое обновление отключается.
docsTimeSlotInterval  - размер временного окна (в минутах), в котором должны содержаться статусы документов. В приведенном выше примере будут изменяться все документы, у которых статус был изменен за прошедший час (от t-1 час до t, где t – текущая дата/время)

Т.о. в примере выше данные статусов документов будут обновляться каждые 30 секунд, при этом берутся только те документы, у которых статусы менялись за последний час.
Для обновления статусов по требованию пользователя достаточно обратиться по адресу (в браузере или через генератор запросов) по адресу http://<your_IP>:5050/monitor
(например, http://192.168.0.142:5050/monitor) 
